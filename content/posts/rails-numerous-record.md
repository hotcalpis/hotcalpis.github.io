---
title: 'Rails で大量レコードを処理する時のやらかしポイント'
date: '2023-12-11'
description: ''
---

会員管理系のWebシステムで会員や売上等のエクスポート機能を実装したのですが、
予想以上に落とし穴が多く、実際にインシデントも起こしてしまったので反省として Rails で大量レコードを扱う際の注意点をまとめます。

## 1. 一括で処理する

ActiveRecord インスタンスはメモリを喰います。
これではメモリを無駄遣いしてしまいます。

実際に計算してみましょう。

## 2. 1000件程度に分割して処理する

### ActiveRecord のメソッドを使う

- in_batches
- find_in_batches
- find_each

- order が指定できない
- Layered Architecture などでは採用しづらい

### 自前で実装する

OFFSET で処理するようにしました

## 3. 【落とし穴その１】OFFSET が大きくなるにつれてクエリが重くなる

## 4. 【落とし穴その２】トランザクションが貼られてないとファントムリードが起きる

### ID だけ取得してから each_slice で処理する

## 5. 【落とし穴その３】SQL キャッシュによりメモリが浪費される

## 6. 【落とし穴その４】ORDER が一意でない場合、取得するレコードに重複・欠損が生じる

### MySQL のREPEATABLE READ の一貫性読み取り

### 24時間稼働が要件の場合は meta data lock を嫌って長いトランザクションを避ける

一括取得して引き直す方法

## 7. 編集系の場合は冪等性？

## 8. tmpfs
